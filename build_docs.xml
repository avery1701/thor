<?xml version="1.0" encoding="UTF-8"?>
<project basedir="." default="default" name="jtor">

	<property name="appname" value="${ant.project.name}"/>
	<property name="build" location="${basedir}/build" />
	<property name="org" value="Advanced Power"/>
	<property name="lib" location="${basedir}/lib"/>
	
	<!-- We're not using a build server, so use version.txt to set the version property -->
	<property name="version.txt" location="${basedir}/version.txt" />

	<loadfile property="version" srcfile="${version.txt}">
		<filterchain>
			<striplinebreaks />
		</filterchain>
	</loadfile>
	
	<property name="versionedApp" value="${appname}-${version}"/>
	
	  <path id="classpath">
        <fileset dir="${lib}">
          <include name="*.jar"/>
        </fileset>
	  </path>

	
	<target name="default" depends="clean, doc, coverage"/>
	

	<target name="clean">
		<delete dir="build"/>
		<delete dir="docs/api" />
		<delete dir="docs/sample_output" />
		<delete dir="docs/source" />
		<delete dir="docs/test_coverage" />
	

		<mkdir dir="build"/>
		<mkdir dir="docs/api" />
		<mkdir dir="docs/sample_output" />
		<mkdir dir="docs/source" />
		<mkdir dir="docs/test_coverage" />
	
	</target>
	
	<taskdef name="java2html" classname="com.java2html.Java2HTMLTask"/>
	
	<target name="doc">
		<javadoc packagenames="com.advancedpwr.*"
	           sourcepath="src"
	           defaultexcludes="yes"
	           destdir="docs/api"
	           author="true"
	           version="true"
	           use="true"
	           windowtitle="Test API">
	    <doctitle><![CDATA[<h1>Java Test Object Recorder</h1>]]></doctitle>
	    <bottom><![CDATA[<i>Copyright &#169; 2014 Advanced Power Co. All Rights Reserved.</i>]]></bottom>
	    <tag name="todo" scope="all" description="To do:"/>
	    <link href="http://download.oracle.com/javase/6/docs/api/"/>
	  </javadoc>
		
		<java2html title="Java Test Object Recorder" 
			simple="no"
	        tabsize="4"
			marginsize="3"
			header="true"
			footer="false"
			destination="docs/source">
			<fileset dir="src">
				<include name="**/*.java"/>
			</fileset>
			<javadoc localRef="docs/api" httpRef="http://jtor.sourceforge.net/docs/api/"/>
		</java2html>
		
		<copy file="docs/java2html.css" tofile="docs/source/stylesheet.css" overwrite="yes"/>

		
		<java2html title="Sample Output from Unit Tests" 
			simple="no"
	        tabsize="4"
			marginsize="3"
			header="true"
			footer="false"
			destination="docs/sample_output">
			<fileset dir="generated">
				<include name="**/*.java"/>
			</fileset>
			<javadoc localRef="docs/api" httpRef="http://jtor.sourceforge.net/docs/api/"/>
		</java2html>
		
		<copy file="docs/java2html.css" tofile="docs/sample_output/stylesheet.css" overwrite="yes"/>
	

	</target>
	
	  <path id="coverage_classpath">
	      <path refid="classpath"/>
	  	  <pathelement location="build"/>
	  </path>
	
	  <path id="squashed_classpath">
			<pathelement location="build"/>
	  </path>
	
	<!-- directory that contains emma.jar and emma_ant.jar: -->
	  <property name="emma.dir" value="/home/avery/opt/apache-ant-1.8.4/lib" />

	  <!-- path element used by EMMA taskdef below: -->
	  <path id="emma.lib" >
	    <pathelement location="${emma.dir}/emma.jar" />
	    <pathelement location="${emma.dir}/emma_ant.jar" />
	  	<path refid="coverage_classpath"/>
	  </path>

	  <!-- this loads <emma> and <emmajava> custom tasks: -->
	  <taskdef resource="emma_ant.properties" classpathref="emma.lib" />
	

	
	<target name="coverage">
		<javac srcdir="src:test"  destdir="build" source="1.5" target="1.5" debug="on">
			<classpath refid="classpath"/>
		</javac>
	    <emmajava enabled="true" libclasspathref="emma.lib" 
	              fullmetadata="yes" sourcepath="src:test"
	              classname="com.advancedpwr.TestMain"
	    		  classpathref="squashed_classpath">
				<filter includes="com.advancedpwr.record.*"/>
	    		<filter excludes="**Test*, **MultiWriter*"/>
	      <!-- <emmajava> option extensions [see the reference manual for
	           complete details]: -->
	      <html outfile="docs/test_coverage/index.html"  />
	    </emmajava>
	</target>
	
</project> 
