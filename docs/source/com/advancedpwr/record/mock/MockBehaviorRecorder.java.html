<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN">
<HTML>
<HEAD>
<LINK REL=STYLESHEET TYPE="text/css" HREF="../../../../stylesheet.css" TITLE="Style">
<META NAME="GENERATOR" CONTENT="Java2HTML Version 1.5">
<TITLE>com.advancedpwr.record.mock.MockBehaviorRecorder (Java2HTML)</TITLE>
</HEAD>
<BODY><TABLE id="Header" border="0" cellpadding="0" cellspacing="0" width="100%">
<tr>
<td colspan="2" width="33%">&nbsp;</td>
<td align="center" colspan="2" width="33%">
<font size="4">MockBehaviorRecorder.java</font>
</td>
<td align="right" colspan="2" width="33%">&nbsp;</td>
</tr>
</TABLE>
<pre ID="Classes">
<FONT ID="LN">1  </FONT><A NAME="1"></A><FONT ID="MultiLineComment">/*
<FONT ID="LN">2  </FONT><A NAME="2"></A> * Copyright 2011 Matthew Avery, mavery@advancedpwr.com
<FONT ID="LN">3  </FONT><A NAME="3"></A> * 
<FONT ID="LN">4  </FONT><A NAME="4"></A> * Licensed under the Apache License, Version 2.0 (the "License");
<FONT ID="LN">5  </FONT><A NAME="5"></A> * you may not use this file except in compliance with the License.
<FONT ID="LN">6  </FONT><A NAME="6"></A> * You may obtain a copy of the License at
<FONT ID="LN">7  </FONT><A NAME="7"></A> * 
<FONT ID="LN">8  </FONT><A NAME="8"></A> *     http://www.apache.org/licenses/LICENSE-2.0
<FONT ID="LN">9  </FONT><A NAME="9"></A> * 
<FONT ID="LN">10 </FONT><A NAME="10"></A> * Unless required by applicable law or agreed to in writing, software
<FONT ID="LN">11 </FONT><A NAME="11"></A> * distributed under the License is distributed on an "AS IS" BASIS,
<FONT ID="LN">12 </FONT><A NAME="12"></A> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
<FONT ID="LN">13 </FONT><A NAME="13"></A> * See the License for the specific language governing permissions and
<FONT ID="LN">14 </FONT><A NAME="14"></A> * limitations under the License.
<FONT ID="LN">15 </FONT><A NAME="15"></A> */</FONT>
<FONT ID="LN">16 </FONT><A NAME="16"></A><FONT ID="Package">package</FONT> com.advancedpwr.record.mock;
<FONT ID="LN">17 </FONT><A NAME="17"></A>
<FONT ID="LN">18 </FONT><A NAME="18"></A><FONT ID="Import">import</FONT> java.io.File;
<FONT ID="LN">19 </FONT><A NAME="19"></A><FONT ID="Import">import</FONT> java.lang.reflect.Modifier;
<FONT ID="LN">20 </FONT><A NAME="20"></A><FONT ID="Import">import</FONT> java.util.Arrays;
<FONT ID="LN">21 </FONT><A NAME="21"></A><FONT ID="Import">import</FONT> java.util.Collection;
<FONT ID="LN">22 </FONT><A NAME="22"></A><FONT ID="Import">import</FONT> java.util.Iterator;
<FONT ID="LN">23 </FONT><A NAME="23"></A><FONT ID="Import">import</FONT> java.util.LinkedHashSet;
<FONT ID="LN">24 </FONT><A NAME="24"></A><FONT ID="Import">import</FONT> java.util.Map;
<FONT ID="LN">25 </FONT><A NAME="25"></A><FONT ID="Import">import</FONT> java.util.Set;
<FONT ID="LN">26 </FONT><A NAME="26"></A>
<FONT ID="LN">27 </FONT><A NAME="27"></A><FONT ID="Import">import</FONT> org.easymock.internal.IProxyFactory;
<FONT ID="LN">28 </FONT><A NAME="28"></A>
<FONT ID="LN">29 </FONT><A NAME="29"></A><FONT ID="Import">import</FONT> <A HREF="../../../../com/advancedpwr/record/BeanRecorder.java.html">com.advancedpwr.record.BeanRecorder</A>;
<FONT ID="LN">30 </FONT><A NAME="30"></A><FONT ID="Import">import</FONT> <A HREF="../../../../com/advancedpwr/record/InstanceTree.java.html">com.advancedpwr.record.InstanceTree</A>;
<FONT ID="LN">31 </FONT><A NAME="31"></A><FONT ID="Import">import</FONT> <A HREF="../../../../com/advancedpwr/record/ObjectRecorder.java.html">com.advancedpwr.record.ObjectRecorder</A>;
<FONT ID="LN">32 </FONT><A NAME="32"></A><FONT ID="Import">import</FONT> <A HREF="../../../../com/advancedpwr/record/factory/MockFactory.java.html">com.advancedpwr.record.factory.MockFactory</A>;
<FONT ID="LN">33 </FONT><A NAME="33"></A><FONT ID="Import">import</FONT> <A HREF="../../../../com/advancedpwr/record/methods/MethodBuilderFactory.java.html">com.advancedpwr.record.methods.MethodBuilderFactory</A>;
<FONT ID="LN">34 </FONT><A NAME="34"></A>
<FONT ID="LN">35 </FONT><A NAME="35"></A><FONT ID="FormalComment">/**
<FONT ID="LN">36 </FONT><A NAME="36"></A> * An {@link ObjectRecorder} that records the &lt;i&gt;behavior&lt;/i&gt; of an object tree as a Java class file.
<FONT ID="LN">37 </FONT><A NAME="37"></A> * The resulting factory class uses &lt;a href="http://easymock.org/"&gt;EasyMock&lt;/a&gt; mock objects to mock the expected behavior of methods
<FONT ID="LN">38 </FONT><A NAME="38"></A> * called on objects throughout the object tree.
<FONT ID="LN">39 </FONT><A NAME="39"></A> * &lt;p&gt;
<FONT ID="LN">40 </FONT><A NAME="40"></A> * Recording example as a JUnit test:
<FONT ID="LN">41 </FONT><A NAME="41"></A> * &lt;/p&gt;
<FONT ID="LN">42 </FONT><A NAME="42"></A> *&lt;p&gt;&lt;blockquote&gt;&lt;pre&gt;
<FONT ID="LN">43 </FONT><A NAME="43"></A>    public void testRecordJavadocExample()
<FONT ID="LN">44 </FONT><A NAME="44"></A>    {
<FONT ID="LN">45 </FONT><A NAME="45"></A>        MockBehaviorRecorder recorder = new MockBehaviorRecorder();
<FONT ID="LN">46 </FONT><A NAME="46"></A>        recorder.setDestination( "recordings" );
<FONT ID="LN">47 </FONT><A NAME="47"></A>        
<FONT ID="LN">48 </FONT><A NAME="48"></A>        Person person = new Person();
<FONT ID="LN">49 </FONT><A NAME="49"></A>        
<FONT ID="LN">50 </FONT><A NAME="50"></A>        Person dad = new Person();
<FONT ID="LN">51 </FONT><A NAME="51"></A>        dad.setName( "dad" );
<FONT ID="LN">52 </FONT><A NAME="52"></A>        person.setDad( dad );
<FONT ID="LN">53 </FONT><A NAME="53"></A>        
<FONT ID="LN">54 </FONT><A NAME="54"></A>        person = recorder.record( person );
<FONT ID="LN">55 </FONT><A NAME="55"></A>        
<FONT ID="LN">56 </FONT><A NAME="56"></A>        person.setName( "Joe" );
<FONT ID="LN">57 </FONT><A NAME="57"></A>        assertEquals( "Joe", person.getName() );
<FONT ID="LN">58 </FONT><A NAME="58"></A>        assertEquals( "dad", person.getDad().getName() );
<FONT ID="LN">59 </FONT><A NAME="59"></A>        assertEquals( "dad", person.getDad().getName() );
<FONT ID="LN">60 </FONT><A NAME="60"></A>        
<FONT ID="LN">61 </FONT><A NAME="61"></A>        Person mom = new Person();
<FONT ID="LN">62 </FONT><A NAME="62"></A>        mom.setName( "mom" );
<FONT ID="LN">63 </FONT><A NAME="63"></A>        person.setMom( mom );
<FONT ID="LN">64 </FONT><A NAME="64"></A>        
<FONT ID="LN">65 </FONT><A NAME="65"></A>        recorder.endRecording();
<FONT ID="LN">66 </FONT><A NAME="66"></A>        
<FONT ID="LN">67 </FONT><A NAME="67"></A>    }
<FONT ID="LN">68 </FONT><A NAME="68"></A> * &lt;/pre&gt;&lt;/blockquote&gt;&lt;p&gt;
<FONT ID="LN">69 </FONT><A NAME="69"></A> * 
<FONT ID="LN">70 </FONT><A NAME="70"></A> * Note that the "person" instance is swapped with an instrumented instance of the "person" object on the line
<FONT ID="LN">71 </FONT><A NAME="71"></A> * 
<FONT ID="LN">72 </FONT><A NAME="72"></A> * &lt;p&gt;&lt;blockquote&gt;&lt;pre&gt;
<FONT ID="LN">73 </FONT><A NAME="73"></A> * person = recorder.record( person );
<FONT ID="LN">74 </FONT><A NAME="74"></A> * &lt;/pre&gt;&lt;/blockquote&gt;&lt;p&gt;
<FONT ID="LN">75 </FONT><A NAME="75"></A> * 
<FONT ID="LN">76 </FONT><A NAME="76"></A> * The above example will record the &lt;i&gt;behavior&lt;/i&gt; of the "person" instance as a tree of mock objects in the Java class:
<FONT ID="LN">77 </FONT><A NAME="77"></A> * 
<FONT ID="LN">78 </FONT><A NAME="78"></A> * &lt;p&gt;&lt;blockquote&gt;&lt;pre&gt;
<FONT ID="LN">79 </FONT><A NAME="79"></A>    public class PersonFactory extends MockFactory
<FONT ID="LN">80 </FONT><A NAME="80"></A>    {
<FONT ID="LN">81 </FONT><A NAME="81"></A>    
<FONT ID="LN">82 </FONT><A NAME="82"></A>        protected Person person;
<FONT ID="LN">83 </FONT><A NAME="83"></A>    
<FONT ID="LN">84 </FONT><A NAME="84"></A>        public Person buildPerson()
<FONT ID="LN">85 </FONT><A NAME="85"></A>        {
<FONT ID="LN">86 </FONT><A NAME="86"></A>            if ( person != null ) 
<FONT ID="LN">87 </FONT><A NAME="87"></A>            {
<FONT ID="LN">88 </FONT><A NAME="88"></A>                return person;
<FONT ID="LN">89 </FONT><A NAME="89"></A>            }
<FONT ID="LN">90 </FONT><A NAME="90"></A>            person = createStrictMock( Person.class );
<FONT ID="LN">91 </FONT><A NAME="91"></A>            person.setName( "Joe" );
<FONT ID="LN">92 </FONT><A NAME="92"></A>            expect( person.getName() ).andReturn( "Joe" );
<FONT ID="LN">93 </FONT><A NAME="93"></A>            expect( person.getDad() ).andReturn( buildPerson_3_1() );
<FONT ID="LN">94 </FONT><A NAME="94"></A>            expect( person.getDad() ).andReturn( buildPerson_3_1() );
<FONT ID="LN">95 </FONT><A NAME="95"></A>            person.setMom( buildPerson_5_1() );
<FONT ID="LN">96 </FONT><A NAME="96"></A>            replay( person );
<FONT ID="LN">97 </FONT><A NAME="97"></A>            return person;
<FONT ID="LN">98 </FONT><A NAME="98"></A>        }
<FONT ID="LN">99 </FONT><A NAME="99"></A>    
<FONT ID="LN">100</FONT><A NAME="100"></A>        protected Person person_3_1;
<FONT ID="LN">101</FONT><A NAME="101"></A>    
<FONT ID="LN">102</FONT><A NAME="102"></A>        protected Person buildPerson_3_1()
<FONT ID="LN">103</FONT><A NAME="103"></A>        {
<FONT ID="LN">104</FONT><A NAME="104"></A>            if ( person_3_1 != null ) 
<FONT ID="LN">105</FONT><A NAME="105"></A>            {
<FONT ID="LN">106</FONT><A NAME="106"></A>                return person_3_1;
<FONT ID="LN">107</FONT><A NAME="107"></A>            }
<FONT ID="LN">108</FONT><A NAME="108"></A>            person_3_1 = createStrictMock( Person.class );
<FONT ID="LN">109</FONT><A NAME="109"></A>            expect( person_3_1.getName() ).andReturn( "dad" );
<FONT ID="LN">110</FONT><A NAME="110"></A>            expect( person_3_1.getName() ).andReturn( "dad" );
<FONT ID="LN">111</FONT><A NAME="111"></A>            replay( person_3_1 );
<FONT ID="LN">112</FONT><A NAME="112"></A>            return person_3_1;
<FONT ID="LN">113</FONT><A NAME="113"></A>        }
<FONT ID="LN">114</FONT><A NAME="114"></A>    
<FONT ID="LN">115</FONT><A NAME="115"></A>        protected Person person_5_1;
<FONT ID="LN">116</FONT><A NAME="116"></A>    
<FONT ID="LN">117</FONT><A NAME="117"></A>        protected Person buildPerson_5_1()
<FONT ID="LN">118</FONT><A NAME="118"></A>        {
<FONT ID="LN">119</FONT><A NAME="119"></A>            if ( person_5_1 != null ) 
<FONT ID="LN">120</FONT><A NAME="120"></A>            {
<FONT ID="LN">121</FONT><A NAME="121"></A>                return person_5_1;
<FONT ID="LN">122</FONT><A NAME="122"></A>            }
<FONT ID="LN">123</FONT><A NAME="123"></A>            person_5_1 = createStrictMock( Person.class );
<FONT ID="LN">124</FONT><A NAME="124"></A>            replay( person_5_1 );
<FONT ID="LN">125</FONT><A NAME="125"></A>            return person_5_1;
<FONT ID="LN">126</FONT><A NAME="126"></A>        }
<FONT ID="LN">127</FONT><A NAME="127"></A>    }
<FONT ID="LN">128</FONT><A NAME="128"></A> * &lt;/pre&gt;&lt;/blockquote&gt;&lt;p&gt;
<FONT ID="LN">129</FONT><A NAME="129"></A> * 
<FONT ID="LN">130</FONT><A NAME="130"></A> * To reconstruct the instance of "person" in a unit test and assert that all method calls are identical to the recorded behavior:
<FONT ID="LN">131</FONT><A NAME="131"></A> * 
<FONT ID="LN">132</FONT><A NAME="132"></A> * &lt;p&gt;&lt;blockquote&gt;&lt;pre&gt;
<FONT ID="LN">133</FONT><A NAME="133"></A>    public void testPlaybackJavadocExample()
<FONT ID="LN">134</FONT><A NAME="134"></A>    {
<FONT ID="LN">135</FONT><A NAME="135"></A>        Person person = new PersonFactory().buildPerson();
<FONT ID="LN">136</FONT><A NAME="136"></A>        
<FONT ID="LN">137</FONT><A NAME="137"></A>        person.setName( "Joe" );
<FONT ID="LN">138</FONT><A NAME="138"></A>        assertEquals( "Joe", person.getName() );
<FONT ID="LN">139</FONT><A NAME="139"></A>        assertEquals( "dad", person.getDad().getName() );
<FONT ID="LN">140</FONT><A NAME="140"></A>        assertEquals( "dad", person.getDad().getName() );
<FONT ID="LN">141</FONT><A NAME="141"></A>        
<FONT ID="LN">142</FONT><A NAME="142"></A>        Person mom = new Person();
<FONT ID="LN">143</FONT><A NAME="143"></A>        mom.setName( "mom" );
<FONT ID="LN">144</FONT><A NAME="144"></A>        person.setMom( mom );
<FONT ID="LN">145</FONT><A NAME="145"></A>    }
<FONT ID="LN">146</FONT><A NAME="146"></A> * &lt;/pre&gt;&lt;/blockquote&gt;&lt;p&gt;
<FONT ID="LN">147</FONT><A NAME="147"></A> * 
<FONT ID="LN">148</FONT><A NAME="148"></A> * Note that the above unit test will &lt;b&gt;fail&lt;/b&gt; because the mock objects are strictly performing checks on all objects they
<FONT ID="LN">149</FONT><A NAME="149"></A> * are interacting with in the object tree.  In the playback test case, the instance of "mom" is not the same instance as the
<FONT ID="LN">150</FONT><A NAME="150"></A> * recorded test case, so the mock objects will complain.  In order to make this test useful, it is necessary to edit the recorded
<FONT ID="LN">151</FONT><A NAME="151"></A> * PersonFactory class and change the line
<FONT ID="LN">152</FONT><A NAME="152"></A> * 
<FONT ID="LN">153</FONT><A NAME="153"></A> * &lt;p&gt;&lt;blockquote&gt;&lt;pre&gt;
<FONT ID="LN">154</FONT><A NAME="154"></A> * person.setMom( buildPerson_5_1() );
<FONT ID="LN">155</FONT><A NAME="155"></A> * &lt;/pre&gt;&lt;/blockquote&gt;&lt;p&gt;
<FONT ID="LN">156</FONT><A NAME="156"></A> * 
<FONT ID="LN">157</FONT><A NAME="157"></A> * to
<FONT ID="LN">158</FONT><A NAME="158"></A> * 
<FONT ID="LN">159</FONT><A NAME="159"></A> * &lt;p&gt;&lt;blockquote&gt;&lt;pre&gt;
<FONT ID="LN">160</FONT><A NAME="160"></A> * person.setMom( anyObject( Person.class ) );
<FONT ID="LN">161</FONT><A NAME="161"></A> * &lt;/pre&gt;&lt;/blockquote&gt;&lt;p&gt;
<FONT ID="LN">162</FONT><A NAME="162"></A> * 
<FONT ID="LN">163</FONT><A NAME="163"></A> * This may be a bug.  If you disagree with this behavior, please open an issue on the &lt;a href="http://jtor.sourceforge.net/"&gt;Java Test Object Recorder&lt;/a&gt; site. 
<FONT ID="LN">164</FONT><A NAME="164"></A> * 
<FONT ID="LN">165</FONT><A NAME="165"></A> * The &lt;code&gt;MockBehaviorRecorder&lt;/code&gt; is "instance aware" and supports {@link Collection} and {@link Map} objects.  This class
<FONT ID="LN">166</FONT><A NAME="166"></A> * requires the EasyMock 3.0 jar and the cglib 2.2 jar.
<FONT ID="LN">167</FONT><A NAME="167"></A> *  
<FONT ID="LN">168</FONT><A NAME="168"></A> * @author Matthew Avery, mavery@advancedpwr.com on Jun 22, 2010
<FONT ID="LN">169</FONT><A NAME="169"></A> *
<FONT ID="LN">170</FONT><A NAME="170"></A> */</FONT>
<FONT ID="LN">171</FONT><A NAME="171"></A>
<FONT ID="LN">172</FONT><A NAME="172"></A><FONT ID="Public">public</FONT> <FONT ID="Class">class</FONT> MockBehaviorRecorder <FONT ID="Extends">extends</FONT> <A HREF="../../../../com/advancedpwr/record/BeanRecorder.java.html">BeanRecorder</A>
<FONT ID="LN">173</FONT><A NAME="173"></A>{
<FONT ID="LN">174</FONT><A NAME="174"></A>    <FONT ID="Protected">protected</FONT> Set&lt;Class&gt; fieldPreferredInterfaces;
<FONT ID="LN">175</FONT><A NAME="175"></A>    
<FONT ID="LN">176</FONT><A NAME="176"></A>    <FONT ID="Public">public</FONT> MockBehaviorRecorder()
<FONT ID="LN">177</FONT><A NAME="177"></A>    {
<FONT ID="LN">178</FONT><A NAME="178"></A>        setSuperClass( <A HREF="../../../../com/advancedpwr/record/factory/MockFactory.java.html">MockFactory</A>.<FONT ID="Class">class</FONT> );
<FONT ID="LN">179</FONT><A NAME="179"></A>        addPreferredInterface( java.sql.Connection.<FONT ID="Class">class</FONT> );
<FONT ID="LN">180</FONT><A NAME="180"></A>        addPreferredInterface( java.sql.PreparedStatement.<FONT ID="Class">class</FONT> );
<FONT ID="LN">181</FONT><A NAME="181"></A>        addPreferredInterface( java.sql.Statement.<FONT ID="Class">class</FONT> );
<FONT ID="LN">182</FONT><A NAME="182"></A>        addPreferredInterface( java.sql.ResultSet.<FONT ID="Class">class</FONT> );
<FONT ID="LN">183</FONT><A NAME="183"></A>        
<FONT ID="LN">184</FONT><A NAME="184"></A>    }
<FONT ID="LN">185</FONT><A NAME="185"></A>    <FONT ID="Protected">protected</FONT> Set&lt;Class&gt; getPreferredInterfaces()
<FONT ID="LN">186</FONT><A NAME="186"></A>    {
<FONT ID="LN">187</FONT><A NAME="187"></A>        <FONT ID="If">if</FONT> ( fieldPreferredInterfaces == <FONT ID="Null">null</FONT> )
<FONT ID="LN">188</FONT><A NAME="188"></A>        {
<FONT ID="LN">189</FONT><A NAME="189"></A>            fieldPreferredInterfaces = <FONT ID="New">new</FONT> LinkedHashSet&lt;Class&gt;();
<FONT ID="LN">190</FONT><A NAME="190"></A>        }
<FONT ID="LN">191</FONT><A NAME="191"></A>        <FONT ID="Return">return</FONT> fieldPreferredInterfaces;
<FONT ID="LN">192</FONT><A NAME="192"></A>    }
<FONT ID="LN">193</FONT><A NAME="193"></A>    
<FONT ID="LN">194</FONT><A NAME="194"></A>    <FONT ID="Public">public</FONT> <FONT ID="Void">void</FONT> addPreferredInterface( Class inClass )
<FONT ID="LN">195</FONT><A NAME="195"></A>    {
<FONT ID="LN">196</FONT><A NAME="196"></A>        <FONT ID="If">if</FONT>( inClass.isInterface() )
<FONT ID="LN">197</FONT><A NAME="197"></A>        {
<FONT ID="LN">198</FONT><A NAME="198"></A>            getPreferredInterfaces().add( inClass );
<FONT ID="LN">199</FONT><A NAME="199"></A>        }
<FONT ID="LN">200</FONT><A NAME="200"></A>    }
<FONT ID="LN">201</FONT><A NAME="201"></A>    
<FONT ID="LN">202</FONT><A NAME="202"></A>    <FONT ID="Protected">protected</FONT> Set&lt;Class&gt; classes()
<FONT ID="LN">203</FONT><A NAME="203"></A>    {
<FONT ID="LN">204</FONT><A NAME="204"></A>        Set&lt;Class&gt; sourceClasses = getInstanceTree().getFactory().classes();
<FONT ID="LN">205</FONT><A NAME="205"></A>        Set&lt;Class&gt; classes = <FONT ID="New">new</FONT> LinkedHashSet();
<FONT ID="LN">206</FONT><A NAME="206"></A>        <FONT ID="For">for</FONT> ( Iterator iterator = sourceClasses.iterator(); iterator.hasNext(); )
<FONT ID="LN">207</FONT><A NAME="207"></A>        {
<FONT ID="LN">208</FONT><A NAME="208"></A>            Class sourceClass = (Class) iterator.next();
<FONT ID="LN">209</FONT><A NAME="209"></A>            <FONT ID="If">if</FONT> ( hasPreferedInterface( sourceClass ) )
<FONT ID="LN">210</FONT><A NAME="210"></A>            {
<FONT ID="LN">211</FONT><A NAME="211"></A>                classes.add( preferredInterface( sourceClass ) );
<FONT ID="LN">212</FONT><A NAME="212"></A>            }
<FONT ID="LN">213</FONT><A NAME="213"></A>            <FONT ID="Else">else</FONT>
<FONT ID="LN">214</FONT><A NAME="214"></A>            {
<FONT ID="LN">215</FONT><A NAME="215"></A>                classes.add(  sourceClass );
<FONT ID="LN">216</FONT><A NAME="216"></A>            }
<FONT ID="LN">217</FONT><A NAME="217"></A>        }
<FONT ID="LN">218</FONT><A NAME="218"></A>        classes.add( <A HREF="../../../../com/advancedpwr/record/factory/MockFactory.java.html">MockFactory</A>.<FONT ID="Class">class</FONT> );
<FONT ID="LN">219</FONT><A NAME="219"></A>        <FONT ID="Return">return</FONT> classes;
<FONT ID="LN">220</FONT><A NAME="220"></A>    }
<FONT ID="LN">221</FONT><A NAME="221"></A>
<FONT ID="LN">222</FONT><A NAME="222"></A>    <FONT ID="Public">public</FONT> &lt;T&gt; T record( T inObject )
<FONT ID="LN">223</FONT><A NAME="223"></A>    {
<FONT ID="LN">224</FONT><A NAME="224"></A>        <FONT ID="Return">return</FONT> instrument( inObject );
<FONT ID="LN">225</FONT><A NAME="225"></A>    }
<FONT ID="LN">226</FONT><A NAME="226"></A>    
<FONT ID="LN">227</FONT><A NAME="227"></A>    <FONT ID="Protected">protected</FONT> <FONT ID="Void">void</FONT> debug( Object inObject )
<FONT ID="LN">228</FONT><A NAME="228"></A>    {
<FONT ID="LN">229</FONT><A NAME="229"></A>        System.out.println( inObject );
<FONT ID="LN">230</FONT><A NAME="230"></A>    }
<FONT ID="LN">231</FONT><A NAME="231"></A>
<FONT ID="LN">232</FONT><A NAME="232"></A>    <FONT ID="Protected">protected</FONT> &lt;T&gt; T instrument( <FONT ID="Final">final</FONT> T inObject )
<FONT ID="LN">233</FONT><A NAME="233"></A>    {
<FONT ID="LN">234</FONT><A NAME="234"></A>        <FONT ID="If">if</FONT> ( !canInstrument( inObject ) )
<FONT ID="LN">235</FONT><A NAME="235"></A>        {
<FONT ID="LN">236</FONT><A NAME="236"></A>            debug( <FONT ID="StringLiteral">"Not able to instrument object "</FONT> + inObject );
<FONT ID="LN">237</FONT><A NAME="237"></A>            <FONT ID="Return">return</FONT> inObject;
<FONT ID="LN">238</FONT><A NAME="238"></A>        }
<FONT ID="LN">239</FONT><A NAME="239"></A>        debug( <FONT ID="StringLiteral">"Instrumenting "</FONT> + inObject.getClass() );
<FONT ID="LN">240</FONT><A NAME="240"></A>        initializeInstanceTree( inObject );
<FONT ID="LN">241</FONT><A NAME="241"></A>        
<FONT ID="LN">242</FONT><A NAME="242"></A>        Class objectClass = inObject.getClass();
<FONT ID="LN">243</FONT><A NAME="243"></A>        <FONT ID="If">if</FONT> ( objectClass.isArray() )
<FONT ID="LN">244</FONT><A NAME="244"></A>        {
<FONT ID="LN">245</FONT><A NAME="245"></A>            <FONT ID="Return">return</FONT> (T)instrumentedArray( (Object[])inObject );
<FONT ID="LN">246</FONT><A NAME="246"></A>        }
<FONT ID="LN">247</FONT><A NAME="247"></A>        <FONT ID="Final">final</FONT> <A HREF="../../../../com/advancedpwr/record/mock/BehaviorInstanceTree.java.html">BehaviorInstanceTree</A> tree = newInstanceTree( inObject );
<FONT ID="LN">248</FONT><A NAME="248"></A>
<FONT ID="LN">249</FONT><A NAME="249"></A>        IProxyFactory&lt;T&gt; factory = createProxyFactory( objectClass );
<FONT ID="LN">250</FONT><A NAME="250"></A>        <FONT ID="Return">return</FONT> factory.createProxy( (Class&lt;T&gt;) objectClass, <FONT ID="New">new</FONT> <A HREF="../../../../com/advancedpwr/record/mock/MockRecordingInvocationHandler.java.html">MockRecordingInvocationHandler</A>( <FONT ID="This">this</FONT>, tree ) );
<FONT ID="LN">251</FONT><A NAME="251"></A>
<FONT ID="LN">252</FONT><A NAME="252"></A>    }
<FONT ID="LN">253</FONT><A NAME="253"></A>    
<FONT ID="LN">254</FONT><A NAME="254"></A>    <FONT ID="Protected">protected</FONT> &lt;T&gt; IProxyFactory&lt;T&gt; createProxyFactory( Class&lt;T&gt; inClass )
<FONT ID="LN">255</FONT><A NAME="255"></A>    {
<FONT ID="LN">256</FONT><A NAME="256"></A>        <FONT ID="If">if</FONT> ( hasPreferedInterface( inClass ) )
<FONT ID="LN">257</FONT><A NAME="257"></A>        {
<FONT ID="LN">258</FONT><A NAME="258"></A>            Class preferedInterace = preferredInterface( inClass );
<FONT ID="LN">259</FONT><A NAME="259"></A>            <FONT ID="Return">return</FONT> <FONT ID="New">new</FONT> <A HREF="../../../../com/advancedpwr/record/mock/InterfaceProxyFactory.java.html">InterfaceProxyFactory</A>&lt;T&gt;( preferedInterace );
<FONT ID="LN">260</FONT><A NAME="260"></A>        }
<FONT ID="LN">261</FONT><A NAME="261"></A>        <FONT ID="Else">else</FONT>
<FONT ID="LN">262</FONT><A NAME="262"></A>        {
<FONT ID="LN">263</FONT><A NAME="263"></A>            <FONT ID="Return">return</FONT> <FONT ID="New">new</FONT> <A HREF="../../../../com/advancedpwr/record/mock/ClassProxyFactory.java.html">ClassProxyFactory</A>&lt;T&gt;();
<FONT ID="LN">264</FONT><A NAME="264"></A>        }
<FONT ID="LN">265</FONT><A NAME="265"></A>    }
<FONT ID="LN">266</FONT><A NAME="266"></A>    
<FONT ID="LN">267</FONT><A NAME="267"></A>    <FONT ID="Protected">protected</FONT> <FONT ID="Boolean">boolean</FONT> hasPreferedInterface( Class inClass )
<FONT ID="LN">268</FONT><A NAME="268"></A>    {
<FONT ID="LN">269</FONT><A NAME="269"></A>        <FONT ID="Return">return</FONT> preferredInterface( inClass ) != <FONT ID="Null">null</FONT>;
<FONT ID="LN">270</FONT><A NAME="270"></A>    }
<FONT ID="LN">271</FONT><A NAME="271"></A>
<FONT ID="LN">272</FONT><A NAME="272"></A>    <FONT ID="Protected">protected</FONT> Class preferredInterface( Class inClass )
<FONT ID="LN">273</FONT><A NAME="273"></A>    {
<FONT ID="LN">274</FONT><A NAME="274"></A>        Set interfaces = <FONT ID="New">new</FONT> <A HREF="../../../../com/advancedpwr/record/mock/Interfaces.java.html">Interfaces</A>().findInterfaces( inClass );
<FONT ID="LN">275</FONT><A NAME="275"></A>        <FONT ID="For">for</FONT> ( Iterator iterator = interfaces.iterator(); iterator.hasNext(); )
<FONT ID="LN">276</FONT><A NAME="276"></A>        {
<FONT ID="LN">277</FONT><A NAME="277"></A>            Class currentInterface = (Class) iterator.next();
<FONT ID="LN">278</FONT><A NAME="278"></A>            <FONT ID="If">if</FONT> ( getPreferredInterfaces().contains( currentInterface ) )
<FONT ID="LN">279</FONT><A NAME="279"></A>            {
<FONT ID="LN">280</FONT><A NAME="280"></A>                <FONT ID="Return">return</FONT> currentInterface;
<FONT ID="LN">281</FONT><A NAME="281"></A>            }
<FONT ID="LN">282</FONT><A NAME="282"></A>        }
<FONT ID="LN">283</FONT><A NAME="283"></A>        <FONT ID="Return">return</FONT> <FONT ID="Null">null</FONT>;
<FONT ID="LN">284</FONT><A NAME="284"></A>    }
<FONT ID="LN">285</FONT><A NAME="285"></A>    
<FONT ID="LN">286</FONT><A NAME="286"></A>    <FONT ID="Protected">protected</FONT> <FONT ID="Boolean">boolean</FONT> isEnhanced( Class objectClass )
<FONT ID="LN">287</FONT><A NAME="287"></A>    {
<FONT ID="LN">288</FONT><A NAME="288"></A>        <FONT ID="Return">return</FONT> objectClass.getSimpleName().contains( <FONT ID="StringLiteral">"CGLIB"</FONT> );
<FONT ID="LN">289</FONT><A NAME="289"></A>    }
<FONT ID="LN">290</FONT><A NAME="290"></A>
<FONT ID="LN">291</FONT><A NAME="291"></A>    <FONT ID="Protected">protected</FONT> <FONT ID="Boolean">boolean</FONT> canInstrument( Object result )
<FONT ID="LN">292</FONT><A NAME="292"></A>    {
<FONT ID="LN">293</FONT><A NAME="293"></A>        <FONT ID="Return">return</FONT> canInstrumentClass( result ) || canInstrumentArray( result ) &amp;&amp; !isEnhanced( result.getClass() );
<FONT ID="LN">294</FONT><A NAME="294"></A>    }
<FONT ID="LN">295</FONT><A NAME="295"></A>
<FONT ID="LN">296</FONT><A NAME="296"></A>    <FONT ID="Protected">protected</FONT> <FONT ID="Boolean">boolean</FONT> canInstrumentClass( Object result )
<FONT ID="LN">297</FONT><A NAME="297"></A>    {
<FONT ID="LN">298</FONT><A NAME="298"></A>        <FONT ID="Return">return</FONT> result != <FONT ID="Null">null</FONT> &amp;&amp; isPublic( result ) &amp;&amp; !isPrimitive( result ) &amp;&amp; !isFinal( result ) &amp;&amp; !isEnhanced( result.getClass() );
<FONT ID="LN">299</FONT><A NAME="299"></A>    }
<FONT ID="LN">300</FONT><A NAME="300"></A>
<FONT ID="LN">301</FONT><A NAME="301"></A>    <FONT ID="Protected">protected</FONT> <FONT ID="Boolean">boolean</FONT> isFinal( Object result )
<FONT ID="LN">302</FONT><A NAME="302"></A>    {
<FONT ID="LN">303</FONT><A NAME="303"></A>        <FONT ID="Return">return</FONT> Modifier.isFinal( result.getClass().getModifiers() );
<FONT ID="LN">304</FONT><A NAME="304"></A>    }
<FONT ID="LN">305</FONT><A NAME="305"></A>
<FONT ID="LN">306</FONT><A NAME="306"></A>    <FONT ID="Protected">protected</FONT> <FONT ID="Boolean">boolean</FONT> isPrimitive( Object result )
<FONT ID="LN">307</FONT><A NAME="307"></A>    {
<FONT ID="LN">308</FONT><A NAME="308"></A>        <FONT ID="Return">return</FONT> result.getClass().isPrimitive();
<FONT ID="LN">309</FONT><A NAME="309"></A>    }
<FONT ID="LN">310</FONT><A NAME="310"></A>
<FONT ID="LN">311</FONT><A NAME="311"></A>    <FONT ID="Protected">protected</FONT> <FONT ID="Boolean">boolean</FONT> isPublic( Object result )
<FONT ID="LN">312</FONT><A NAME="312"></A>    {
<FONT ID="LN">313</FONT><A NAME="313"></A>        <FONT ID="Return">return</FONT> Modifier.isPublic( result.getClass().getModifiers() ) || hasPreferedInterface( result.getClass() );
<FONT ID="LN">314</FONT><A NAME="314"></A>    }
<FONT ID="LN">315</FONT><A NAME="315"></A>    
<FONT ID="LN">316</FONT><A NAME="316"></A>    <FONT ID="Protected">protected</FONT> <FONT ID="Boolean">boolean</FONT> canInstrumentArray( Object result )
<FONT ID="LN">317</FONT><A NAME="317"></A>    {
<FONT ID="LN">318</FONT><A NAME="318"></A>        <FONT ID="Return">return</FONT> result != <FONT ID="Null">null</FONT> &amp;&amp; result.getClass().isArray() &amp;&amp; !result.getClass().getComponentType().isPrimitive();
<FONT ID="LN">319</FONT><A NAME="319"></A>    }
<FONT ID="LN">320</FONT><A NAME="320"></A>    
<FONT ID="LN">321</FONT><A NAME="321"></A>    <FONT ID="Protected">protected</FONT> &lt;T&gt; T[] instrumentedArray( T[] inArray )
<FONT ID="LN">322</FONT><A NAME="322"></A>    {
<FONT ID="LN">323</FONT><A NAME="323"></A>        <FONT ID="If">if</FONT> ( inArray == <FONT ID="Null">null</FONT> )
<FONT ID="LN">324</FONT><A NAME="324"></A>        {
<FONT ID="LN">325</FONT><A NAME="325"></A>            <FONT ID="Return">return</FONT> (T[]) <FONT ID="New">new</FONT> Object[<FONT ID="IntegerLiteral">0</FONT>];
<FONT ID="LN">326</FONT><A NAME="326"></A>        }
<FONT ID="LN">327</FONT><A NAME="327"></A>        T[] array = Arrays.copyOf( inArray, inArray.length );
<FONT ID="LN">328</FONT><A NAME="328"></A>        <FONT ID="For">for</FONT> ( <FONT ID="Int">int</FONT> i = <FONT ID="IntegerLiteral">0</FONT>; i &lt; inArray.length; i++ )
<FONT ID="LN">329</FONT><A NAME="329"></A>        {
<FONT ID="LN">330</FONT><A NAME="330"></A>            <FONT ID="If">if</FONT> ( canInstrument( inArray[i] ) )
<FONT ID="LN">331</FONT><A NAME="331"></A>            {
<FONT ID="LN">332</FONT><A NAME="332"></A>                array[i] = instrument( inArray[i] );
<FONT ID="LN">333</FONT><A NAME="333"></A>            }
<FONT ID="LN">334</FONT><A NAME="334"></A>        }
<FONT ID="LN">335</FONT><A NAME="335"></A>        <FONT ID="Return">return</FONT> array;
<FONT ID="LN">336</FONT><A NAME="336"></A>    }
<FONT ID="LN">337</FONT><A NAME="337"></A>
<FONT ID="LN">338</FONT><A NAME="338"></A>    <FONT ID="Protected">protected</FONT> <A HREF="../../../../com/advancedpwr/record/mock/BehaviorInstanceTree.java.html">BehaviorInstanceTree</A> newInstanceTree( <FONT ID="Final">final</FONT> Object inObject )
<FONT ID="LN">339</FONT><A NAME="339"></A>    {
<FONT ID="LN">340</FONT><A NAME="340"></A>        <A HREF="../../../../com/advancedpwr/record/mock/BehaviorInstanceTree.java.html">BehaviorInstanceTree</A> tree = (<A HREF="../../../../com/advancedpwr/record/mock/BehaviorInstanceTree.java.html">BehaviorInstanceTree</A>)getInstanceTree().getFactory().createInstanceTree( inObject, getInstanceTree() );
<FONT ID="LN">341</FONT><A NAME="341"></A>        tree.setPreferredInterface( preferredInterface( inObject.getClass() ) );
<FONT ID="LN">342</FONT><A NAME="342"></A>        <FONT ID="Return">return</FONT> tree;
<FONT ID="LN">343</FONT><A NAME="343"></A>    }
<FONT ID="LN">344</FONT><A NAME="344"></A>
<FONT ID="LN">345</FONT><A NAME="345"></A>    <FONT ID="Protected">protected</FONT> <FONT ID="Void">void</FONT> initializeInstanceTree( Object inObject )
<FONT ID="LN">346</FONT><A NAME="346"></A>    {
<FONT ID="LN">347</FONT><A NAME="347"></A>        <FONT ID="If">if</FONT> ( fieldInstanceTree == <FONT ID="Null">null</FONT> )
<FONT ID="LN">348</FONT><A NAME="348"></A>        {
<FONT ID="LN">349</FONT><A NAME="349"></A>            fieldInstanceTree = createInstanceTree( inObject );
<FONT ID="LN">350</FONT><A NAME="350"></A>        }
<FONT ID="LN">351</FONT><A NAME="351"></A>    }
<FONT ID="LN">352</FONT><A NAME="352"></A>
<FONT ID="LN">353</FONT><A NAME="353"></A>    <FONT ID="FormalComment">/**
<FONT ID="LN">354</FONT><A NAME="354"></A>     * End monitoring of the object being recorded and trigger the writing of the factory file.
<FONT ID="LN">355</FONT><A NAME="355"></A>     *  
<FONT ID="LN">356</FONT><A NAME="356"></A>     * @return - Returns the original, un-instrumented object.
<FONT ID="LN">357</FONT><A NAME="357"></A>     */</FONT>
<FONT ID="LN">358</FONT><A NAME="358"></A>    <FONT ID="Public">public</FONT> Object endRecording()
<FONT ID="LN">359</FONT><A NAME="359"></A>    {
<FONT ID="LN">360</FONT><A NAME="360"></A>        writePackage();
<FONT ID="LN">361</FONT><A NAME="361"></A>        writeImports();
<FONT ID="LN">362</FONT><A NAME="362"></A>        writeClassDeclaration();
<FONT ID="LN">363</FONT><A NAME="363"></A>        openBrace();
<FONT ID="LN">364</FONT><A NAME="364"></A>        writeObjectBuilderMethod();
<FONT ID="LN">365</FONT><A NAME="365"></A>        closeBrace();
<FONT ID="LN">366</FONT><A NAME="366"></A>        closeFile();
<FONT ID="LN">367</FONT><A NAME="367"></A>        debug( <FONT ID="StringLiteral">"Finished recording "</FONT> + getDestination().getAbsolutePath() + File.separator + getDescriptor().toString() );
<FONT ID="LN">368</FONT><A NAME="368"></A>        <FONT ID="Return">return</FONT> getObject();
<FONT ID="LN">369</FONT><A NAME="369"></A>    }
<FONT ID="LN">370</FONT><A NAME="370"></A>
<FONT ID="LN">371</FONT><A NAME="371"></A>    <FONT ID="Protected">protected</FONT> <A HREF="../../../../com/advancedpwr/record/methods/MethodBuilderFactory.java.html">MethodBuilderFactory</A> createMethodBuilderFactory()
<FONT ID="LN">372</FONT><A NAME="372"></A>    {
<FONT ID="LN">373</FONT><A NAME="373"></A>        <A HREF="../../../../com/advancedpwr/record/methods/MethodBuilderFactory.java.html">MethodBuilderFactory</A> factory = <FONT ID="New">new</FONT> <A HREF="../../../../com/advancedpwr/record/methods/MethodBuilderFactory.java.html">MethodBuilderFactory</A>();
<FONT ID="LN">374</FONT><A NAME="374"></A>        <A HREF="../../../../com/advancedpwr/record/mock/MockMethodBuilderFactory.java.html">MockMethodBuilderFactory</A> mockFactory = <FONT ID="New">new</FONT> <A HREF="../../../../com/advancedpwr/record/mock/MockMethodBuilderFactory.java.html">MockMethodBuilderFactory</A>();
<FONT ID="LN">375</FONT><A NAME="375"></A>        mockFactory.setNice( isNice() );
<FONT ID="LN">376</FONT><A NAME="376"></A>        factory.setDefaultFactory( mockFactory );
<FONT ID="LN">377</FONT><A NAME="377"></A>        <FONT ID="Return">return</FONT> factory;
<FONT ID="LN">378</FONT><A NAME="378"></A>    }
<FONT ID="LN">379</FONT><A NAME="379"></A>
<FONT ID="LN">380</FONT><A NAME="380"></A>    <FONT ID="Protected">protected</FONT> <A HREF="../../../../com/advancedpwr/record/InstanceTree.java.html">InstanceTree</A> createInstanceTree( Object object )
<FONT ID="LN">381</FONT><A NAME="381"></A>    {
<FONT ID="LN">382</FONT><A NAME="382"></A>        <FONT ID="Return">return</FONT> createBehaviorInstanceTree( object );
<FONT ID="LN">383</FONT><A NAME="383"></A>    }
<FONT ID="LN">384</FONT><A NAME="384"></A>
<FONT ID="LN">385</FONT><A NAME="385"></A>    <FONT ID="Protected">protected</FONT> <A HREF="../../../../com/advancedpwr/record/mock/BehaviorInstanceTree.java.html">BehaviorInstanceTree</A> createBehaviorInstanceTree( Object object )
<FONT ID="LN">386</FONT><A NAME="386"></A>    {
<FONT ID="LN">387</FONT><A NAME="387"></A>        <A HREF="../../../../com/advancedpwr/record/mock/BehaviorInstanceTree.java.html">BehaviorInstanceTree</A> tree = <FONT ID="New">new</FONT> <A HREF="../../../../com/advancedpwr/record/mock/BehaviorInstanceTree.java.html">BehaviorInstanceTree</A>( object );
<FONT ID="LN">388</FONT><A NAME="388"></A>        tree.setPreferredInterface( preferredInterface( object.getClass() ) );
<FONT ID="LN">389</FONT><A NAME="389"></A>        <FONT ID="Return">return</FONT> tree;
<FONT ID="LN">390</FONT><A NAME="390"></A>    }
<FONT ID="LN">391</FONT><A NAME="391"></A>
<FONT ID="LN">392</FONT><A NAME="392"></A>    <FONT ID="Protected">protected</FONT> <FONT ID="Boolean">boolean</FONT> fieldNice;
<FONT ID="LN">393</FONT><A NAME="393"></A>
<FONT ID="LN">394</FONT><A NAME="394"></A>    <FONT ID="Public">public</FONT> <FONT ID="Boolean">boolean</FONT> isNice()
<FONT ID="LN">395</FONT><A NAME="395"></A>    {
<FONT ID="LN">396</FONT><A NAME="396"></A>        <FONT ID="Return">return</FONT> fieldNice;
<FONT ID="LN">397</FONT><A NAME="397"></A>    }
<FONT ID="LN">398</FONT><A NAME="398"></A>    <FONT ID="FormalComment">/**
<FONT ID="LN">399</FONT><A NAME="399"></A>     * Create "nice" EasyMock objects rather than the default strict mocks.
<FONT ID="LN">400</FONT><A NAME="400"></A>     * 
<FONT ID="LN">401</FONT><A NAME="401"></A>     * @param nice
<FONT ID="LN">402</FONT><A NAME="402"></A>     */</FONT>
<FONT ID="LN">403</FONT><A NAME="403"></A>    <FONT ID="Public">public</FONT> <FONT ID="Void">void</FONT> setNice( <FONT ID="Boolean">boolean</FONT> nice )
<FONT ID="LN">404</FONT><A NAME="404"></A>    {
<FONT ID="LN">405</FONT><A NAME="405"></A>        fieldNice = nice;
<FONT ID="LN">406</FONT><A NAME="406"></A>    }
<FONT ID="LN">407</FONT><A NAME="407"></A>}
<FONT ID="LN">408</FONT><A NAME="408"></A></pre>
</BODY>
</HTML>